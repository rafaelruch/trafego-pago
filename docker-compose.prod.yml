# docker-compose.prod.yml — VPS / EasyPanel
#
# Domínio de produção:
#   Frontend : https://trafego.ruch.com.br
#   Backend  : https://apitrafego.ruch.com.br
#
# No EasyPanel:
#   1. Crie um serviço PostgreSQL separado no painel
#   2. Configure as variáveis de ambiente abaixo no painel do EasyPanel
#   3. O EasyPanel vai buildar as imagens a partir do GitHub
#
# Variáveis obrigatórias no EasyPanel (backend):
#   DATABASE_URL      = postgresql://user:pass@host:5432/gestor_trafego
#   META_APP_ID       = 1008535358112208
#   META_APP_SECRET   = (chave secreta do app Meta)
#   META_REDIRECT_URI = https://apitrafego.ruch.com.br/api/auth/callback
#   ANTHROPIC_API_KEY = sk-ant-...
#   SECRET_KEY        = (string aleatória longa para JWT)
#   CORS_ORIGINS      = ["https://trafego.ruch.com.br"]
#   FRONTEND_URL      = https://trafego.ruch.com.br
#
# Variáveis obrigatórias no EasyPanel (frontend):
#   BACKEND_URL = http://backend:8000  ← nome do serviço na rede Docker interna

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: always
    environment:
      DATABASE_URL: ${DATABASE_URL}
      META_APP_ID: ${META_APP_ID}
      META_APP_SECRET: ${META_APP_SECRET}
      META_REDIRECT_URI: ${META_REDIRECT_URI:-https://apitrafego.ruch.com.br/api/auth/callback}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      SECRET_KEY: ${SECRET_KEY}
      CORS_ORIGINS: ${CORS_ORIGINS:-["https://trafego.ruch.com.br"]}
      FRONTEND_URL: ${FRONTEND_URL:-https://trafego.ruch.com.br}
      ENVIRONMENT: production
    ports:
      - "8000:8000"
    command: uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: always
    environment:
      # BACKEND_URL é lida em runtime pelo Next.js — não precisa de build arg
      BACKEND_URL: ${BACKEND_URL:-http://backend:8000}
    ports:
      - "3000:3000"
    depends_on:
      - backend
